<head>
    <style>
        textarea {
            width: 500px;
            min-height: 75px;
        }
    </style>
    <script>
        let pc = new RTCPeerConnection({
            iceServers: [
                {
                    urls: 'stun:stun.l.google.com:19302'
                }
            ]
        })
        let log = msg => {
            document.getElementById('logs').innerHTML += msg + '<br>'
        }

        let sendChannel = pc.createDataChannel('foo')
        sendChannel.onclose = () => console.log('sendChannel has closed')
        sendChannel.onopen = () => console.log('sendChannel has opened')
        sendChannel.onmessage = e => log(`Message from DataChannel '${sendChannel.label}' payload '${e.data}'`)

        pc.oniceconnectionstatechange = e => log(pc.iceConnectionState)
        pc.onicecandidate = event => {
            if (event.candidate === null) {
                document.getElementById('localSessionDescription').value = JSON.stringify(pc.localDescription)
            }
        }

        pc.onnegotiationneeded = e =>
            pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log)

        sendMessage = () => {
            let message = document.getElementById('message').value
            if (message === '') {
                return alert('Message must not be empty')
            }
            log(`Message sent to DataChannel '${sendChannel.label}' payload '${message}'`);
            sendChannel.send(message)
        }

        startSession = async () => {
            console.log('sending sdp signal');
            const res = await fetch("http://localhost:4210/sdp", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(pc.localDescription)
            });
            const sd = await res.json();
            console.log(sd);
            if (sd === '') {
                return alert('Session Description must not be empty')
            }
            document.getElementById('remoteSessionDescription').value = JSON.stringify(sd);

            try {
                pc.setRemoteDescription(new RTCSessionDescription(sd))
            } catch (e) {
                alert(e)
            }
        }
    </script>
</head>

<body>
    Browser base64 Session Description <textarea id="localSessionDescription" readonly="true"></textarea> <br />
    Server base64 Session Description: <textarea id="remoteSessionDescription"></textarea> <br />
    <button onclick="startSession()"> Start Session </button> <br />
    <br />

    Message: <textarea id="message">This is my DataChannel message!</textarea> <br />
    <button onclick="sendMessage()"> Send Message </button> <br />

    <div id="logs"></div>
</body>

